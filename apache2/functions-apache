# Etersoft (c) 2013
# Sync to nginx-etersoft/apache2 and etersoft-admin-essential after change


# get one var from virtualhost config
get_var()
{
	grep -i "^ *$2 " "$1" | head -n 1 | sed -e "s/^[ \t]*$2[ \t]*//g" | sed -e 's/"//g'
}

#getVar()
#{
#    cat $1 | sed -e "s/^[ \t]*\(.*\)/\1/g" | grep -v "^#" | grep "^$2" | cut -f 2 -d" "
#}


# get all var values from virtualhost config
get_multivar()
{
	grep -i "^ *$2 " "$1" | sed -e "s/^[ \t]*$2[ \t]*//g" | sed -e 's/"//g'
}

# returns sorted aliases list
get_aliaslist()
{
    local conf=$1
    local SITE=$(get_var $conf ServerName)
    local techhost=$TECHHOST
    [ -n "$techhost" ] || techhost="UNKNOWNTECHHOST"
    # first xargs -n1 for get line by line, next xargs - for get one line output
    get_multivar $conf ServerAlias | xargs -n1 echo | sort -u | grep -v "^$SITE\$" | grep -v "^www.$SITE\$" | grep -v "$techhost$" | xargs echo
}

# needs: DOMAINNAME
create_site_config()
{
local aliaslist=
# for get space before
[ -n "$ALIASLIST" ] && aliaslist=" $ALIASLIST"

if [ -n "DISABLE_LOG" ] ; then
    ERRLOGNAME=/dev/null
    CUSLOGNAME=/dev/null
else
    ERRLOGNAME=$LOGDIR/${TECHNAME}_error.log
    CUSLOGNAME=$LOGDIR/${TECHNAME}_access.log
fi

# fix for upload_tmp_dir
local PHPINCLUDE=/etc/httpd2/conf/include
[ -r $PHPINCLUDE/prepend.php ] || echo "<?php putenv('TMPDIR='.ini_get('upload_tmp_dir'));" >$PHPINCLUDE/prepend.php

cat <<EOF >$DOMAINNAME.conf.new
# Autogenerated by $0
# DO NOT CHANGE MANUALLY, YOUR CHANGES WILL BE OVERWRITTEN!
#NameVirtualHost *

# ----- $1 -----
<VirtualHost *>
    ServerName $DOMAINNAME
    ServerAlias www.$DOMAINNAME $TECHALIAS$aliaslist
    AssignUserID $USERNAME $USERNAME
    php_admin_value session.save_path "$SESSIONDIR"
    # Due http://drupal.stackexchange.com/questions/10646/i-get-tmp-is-not-writeable-by-the-webserver-on-migration
    # NOTE: /tmp for open_basedir
    php_admin_value open_basedir "$SITEDIR:$USERTMPDIR:$PHPINCLUDE:/tmp"
    php_admin_value upload_tmp_dir "$USERTMPDIR"
    php_admin_value auto_prepend_file "$PHPINCLUDE/prepend.php"
    ServerAdmin $ADMINMAIL
    DocumentRoot "$SITEDIR"
    ErrorLog $ERRLOGNAME
    CustomLog $CUSLOGNAME common
</VirtualHost>
EOF

rewrite_if_changed $DOMAINNAME.conf.new $DOMAINNAME.conf
}


parse_site_config()
{
    DOMAINNAME=$(get_var $i ServerName | tr [A-Z] [a-z])
    USERNAME=$(get_var $i AssignUserID | cut -f1 -d" ")
    [ -n "$DOMAINNAME" ] || fatal

    echo
    echo "*** File $i, site: $DOMAINNAME, user: $USERNAME"
    if [ "$(basename $i)" != "$DOMAINNAME.conf" ] ; then
        fatal "$i: file conf name and site name are not equal!"
    fi

    ALIASLIST=$(get_aliaslist $i)
    [ -z "$ALIASLIST" ] || echo "   Alias list: $ALIASLIST"
}
